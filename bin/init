#!/bin/bash
#
# DMC Bootstrap Script
########################################################################

initialize() {
	docker network create "$APPLICATION"
	for ENVIRONMENT in ${ENVIRONMENTS[@]}; do
		bin/dmc -b -i "$APPLICATION" -t "$ENVIRONMENT" 2>/dev/null
		storage
	done
}

storage() {
	docker run -d -p 6379:6379 --name "$ENVIRONMENT.db" --network "$APPLICATION" -v var:/data redis:alpine
	for DIR in ${SHARES[@]}; do
		docker volume create --label "share=$DIR" --name "$DIR"
		rsync -a "$DIR/" "/var/lib/docker/volumes/$DIR/_data/"
		docker create -v "$DIR:/opt/$APPLICATION/$DIR" --name "$ENVIRONMENT.$DIR" "$APPLICATION:$ENVIRONMENT" /bin/true
	done
}


# source configuration
. bin/env

# empty storage from previous runs
bin/purge

# add environments and shares
initialize

# build configured images
bin/build

# activate containers
bin/start

