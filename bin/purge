#!/bin/bash
#
# DMC Purge Script
########################################################################

destroy() {
	if [ -n "$CONTAINERS" ]; then
		echo "PURGING CONTAINERS"
		for CONTAINER in ${CONTAINERS[@]}; do
			drop | sort -u
		done
	fi
	if [ -n "$IMAGES" ]; then
		echo "PURGING IMAGES"
		for IMAGE in ${IMAGES[@]}; do
			docker rmi -f "$IMAGE"
		done
	fi
	if [ -n "$VOLUMES" ]; then
		echo "PURGING VOLUMES"
		for VOLUME in ${VOLUMES[@]}; do
			docker volume rm "$VOLUME"
		done
	fi
}

drop() {
	docker kill "$CONTAINER" 2>/dev/null
	docker rm -f "$CONTAINER"
}

search() {
	CONTAINERS=$(docker ps -a | grep -v ^CONTAINER | awk '{print $NF}')
	IMAGES=$(docker images | grep -v -e ^REPOSITORY -e ^node | awk '{print $3}')
	VOLUMES=$(docker volume ls | grep -v ^DRIVER | awk '{print $2}')
}


# shut it down
search && destroy

