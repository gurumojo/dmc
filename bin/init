#!/bin/bash
#
# DMC Bootstrap Script
########################################################################

environment() {
	cd service/base
	mv Dockerfile tmp
	sed -e "s;\(${APPLICATION^^}=\)[a-z]*;\1$ENVIRONMENT;" < tmp > Dockerfile
	docker build --rm -t "$APPLICATION:$ENVIRONMENT" .
	mv tmp Dockerfile
	cd - &>/dev/null
}

initialize() {
	NETWORK=$(docker network ls | grep -c "$APPLICATION")
	(( $NETWORK )) || docker network create "$APPLICATION"
	for ENVIRONMENT in ${ENVIRONMENTS[@]}; do
		environment
		storage
	done
}

storage() {
	for DIR in ${SHARES[@]}; do
		docker volume create --name "$ENVIRONMENT-$DIR"
		rsync -a "$DIR/" "/var/lib/docker/volumes/$ENVIRONMENT-$DIR/_data/"
		docker create -v "$ENVIRONMENT-$DIR:/opt/$APPLICATION/$DIR" --name "$ENVIRONMENT.$DIR" "$APPLICATION:$ENVIRONMENT" /bin/true
	done
}


# source configuration
. bin/env

# empty storage from previous runs
bin/purge

# add environments and shares
initialize

# build configured images
bin/build

# activate containers
bin/start

