#!/bin/bash
#
# DMC Restart Script
########################################################################

import() {
	echo '#!/bin/bash' > "$FILE"
	echo "$1" >> "$FILE"
	. "$FILE"
}

parse() {
	echo "$CONTAINER" > "$FILE"
	JSON=$(jq -r 'keys[] as $k | . as $v | [($k | ascii_upcase), (.[$k] | tostring)] | join("=")' "$FILE")
	import "$JSON"
	rm "$FILE"
}

restart() {
	bin/dmc -r -c "$CONTAINER" -i "$IMAGE" -p "$PORT" -t "$TAG" -v "$VOLUME"
}

validate() {
	[ -n "$CONTAINER" ] && [ -n "$IMAGE" ] && [ -n "$PORT" ] && [ -n "$TAG" ] && [ -n "$VOLUME" ] || return 1
}


FILE=$(tempfile)

# source configuration
. bin/env

# activate containers
for CONTAINER in ${CONTAINERS[@]}; do
	parse && validate && restart &>/dev/null || echo "FAIL: $CONTAINER"
done

